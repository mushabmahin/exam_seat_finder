<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin – Add Roll Range</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
      body { font-family: 'Inter', sans-serif; background-color: #f4f7fb; }
    </style>
  </head>

  <body class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden">

      <div class="bg-blue-600 text-white px-6 py-8">
        <h1 class="text-2xl font-bold">Admin — Add Roll Range</h1>
        <p class="text-blue-100 text-sm mt-1">Add roll ranges (no admin key required)</p>
      </div>

      <div class="p-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Prefix</label>
            <input id="prefix" placeholder="E.g. MUT23AD" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 uppercase" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Branch</label>
            <select id="branch" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
              <option value="">Choose Branch</option>
              <option value="AIDS">AI &amp; DS</option>
              <option value="CSE-A">CSE-A</option>
              <option value="CSE-B">CSE-B</option>
              <option value="CS-AI">CS-AI</option>
              <option value="ECE">ECE</option>
              <option value="EEE">EEE</option>
              <option value="ME">Mechanical</option>
              <option value="CE">Civil</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Starting Roll No:</label>
            <input id="start" type="number" placeholder="Start" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Ending Roll No:</label>
            <input id="end" type="number" placeholder="End" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500" />
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Year</label>
            <select id="year" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500">
              <option value="">Choose Year</option>
              <option value="1">1st Year</option>
              <option value="2">2nd Year</option>
              <option value="3">3rd Year</option>
              <option value="4">4th Year</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-semibold text-slate-700 mb-2">Room No:</label>
            <input id="room" placeholder="E.G. 101" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500" />
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Location</label>
            <input id="location" placeholder="Block / Building" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500" />
          </div>

      <!-- Admin key not required in this deployment -->
        </div>

        <div id="status" class="mt-4"></div>

        <div class="mt-6 flex gap-3">
          <button id="addBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">Add Seats</button>
          <button id="clearBtn" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-medium py-3 px-6 rounded-lg transition">Clear Form</button>
          <button id="clearDbBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition">Clear Database</button>
        </div>

        <div id="msg" class="mt-6"></div>
      </div>
    </div>

    <p class="text-xs text-slate-500 mt-6 text-center">&copy;  MITS Exam Cell</p>

    <script>
  const prefix = document.getElementById('prefix');
  const start = document.getElementById('start');
  const end = document.getElementById('end');
  const branch = document.getElementById('branch');
  const year = document.getElementById('year');
  const room = document.getElementById('room');
  const locationInput = document.getElementById('location');
  const msg = document.getElementById('msg');
  const statusBox = document.getElementById('status');
  const addBtn = document.getElementById('addBtn');
  const clearBtn = document.getElementById('clearBtn');

      clearBtn.addEventListener('click', () => {
  prefix.value = '';
  start.value = '';
  end.value = '';
  branch.value = '';
  year.value = '';
  room.value = '';
  locationInput.value = '';
  msg.innerHTML = '';
      });

      // Fetch server status to show DB connection / config info
      async function fetchStatus() {
        try {
          const res = await fetch('/api/seats/status');
          const s = await res.json();

          if (s.dbConnected) {
            statusBox.innerHTML = '<p class="text-sm text-emerald-600">Connected to MongoDB</p>';
          } else if (!s.mongoUriConfigured) {
            statusBox.innerHTML = '<p class="text-sm text-red-600">MongoDB not configured (set MONGO_URI in .env)</p>';
          } else {
            statusBox.innerHTML = '<p class="text-sm text-orange-600">MongoDB not connected (check server logs)</p>';
          }

          // informative note about admin key presence (optional)
          if (s.adminApiKeyConfigured) {
            statusBox.innerHTML += '<p class="text-xs text-slate-500 mt-1">Admin API key is configured on server.</p>';
          } else {
            statusBox.innerHTML += '<p class="text-xs text-slate-500 mt-1">Admin API key not configured on server.</p>';
          }

          // Enable/disable clear DB button depending on DB connection
          const btn = document.getElementById('clearDbBtn');
          if (btn) btn.disabled = !s.dbConnected;
        } catch (err) {
          console.error('Status fetch failed', err);
          statusBox.innerHTML = '<p class="text-sm text-red-600">Unable to reach status endpoint</p>';
        }
      }

      fetchStatus();

  // Enable/disable Clear DB button based on DB connection
  const clearDbBtn = document.getElementById('clearDbBtn');
  if (clearDbBtn) clearDbBtn.disabled = true;

        addBtn.addEventListener('click', async () => {
        msg.innerHTML = '';

        const payload = {
          prefix: prefix.value.trim(),
          start: Number(start.value),
          end: Number(end.value),
          branch: branch.value.trim(),
          year: Number(year.value),
          room: room.value.trim(),
          location: locationInput.value.trim()
        };

        // Basic client-side validation
        if (!payload.prefix || !payload.branch || !payload.room || !payload.location || !payload.start || !payload.end || !payload.year) {
          msg.innerHTML = '<p class="text-sm text-red-600">Please fill all fields.</p>';
          return;
        }

        // Disable button while previewing
        addBtn.disabled = true;
        addBtn.classList.add('opacity-60');

        try {
          // First ask for a preview to detect duplicates without modifying DB
          const previewRes = await fetch('/api/seats/add-range', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.assign({}, payload, { preview: true }))
          });

          const preview = await previewRes.json();

          if (!previewRes.ok) {
            const errorMsg = preview.message || preview.error || 'Preview failed';
            msg.innerHTML = `<p class="text-sm text-red-600">${errorMsg}</p>`;
            return;
          }

          // If there are duplicates, show a confirmation modal
          if (preview.duplicateCount && preview.duplicateCount > 0) {
            showConfirmModal(preview, async (confirmed) => {
              if (!confirmed) {
                msg.innerHTML = '<p class="text-sm text-slate-600">Operation cancelled.</p>';
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-60');
                return;
              }
              // proceed with actual upload
              await performUpload(payload);
            });
          } else {
            // no duplicates — proceed directly
            await performUpload(payload);
          }

        } catch (err) {
          console.error(err);
          msg.innerHTML = '<p class="text-sm text-red-600">Network or server error</p>';
        } finally {
          // keep disabled state handled by performUpload or re-enable
        }
      });

      // Perform the actual upload (no preview)
      async function performUpload(payload) {
        try {
          const res = await fetch('/api/seats/add-range', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await res.json();

          if (!res.ok) {
            const errorMsg = result.message || result.error || 'Error';
            msg.innerHTML = `<p class="text-sm text-red-600">${errorMsg}</p>`;
          } else {
            const htmlParts = [];
            htmlParts.push(`<p class="text-sm text-slate-600">Generated: <strong>${result.generated}</strong></p>`);
            htmlParts.push(`<p class="text-sm text-slate-600">Inserted (new): <strong>${result.inserted}</strong></p>`);
            htmlParts.push(`<p class="text-sm text-slate-600">Replaced (existing): <strong>${result.replacedAttempted}</strong></p>`);
            htmlParts.push(`<p class="text-sm text-slate-600">Actually modified: <strong>${result.replacedModified}</strong></p>`);

            if (result.insertedRolls && result.insertedRolls.length) {
              htmlParts.push('<details class="mt-2"><summary class="text-xs text-slate-500 cursor-pointer">View inserted rolls</summary>');
              htmlParts.push(`<div class="text-xs text-slate-700 mt-2 whitespace-pre-wrap">${result.insertedRolls.join(', ')}</div>`);
              htmlParts.push('</details>');
            }

            if (result.replacedRolls && result.replacedRolls.length) {
              htmlParts.push('<details class="mt-2"><summary class="text-xs text-slate-500 cursor-pointer">View replaced rolls</summary>');
              htmlParts.push(`<div class="text-xs text-slate-700 mt-2 whitespace-pre-wrap">${result.replacedRolls.join(', ')}</div>`);
              htmlParts.push('</details>');
            }

            msg.innerHTML = `<div class="p-4 bg-slate-50 border border-slate-100 rounded-lg">${htmlParts.join('')}</div>`;
          }
        } catch (err) {
          console.error(err);
          msg.innerHTML = '<p class="text-sm text-red-600">Network or server error</p>';
        } finally {
          addBtn.disabled = false;
          addBtn.classList.remove('opacity-60');
        }
      }

      // Show a simple confirm modal listing duplicates and asking to continue
      function showConfirmModal(preview, callback) {
        // overlay
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';

        const box = document.createElement('div');
        box.className = 'bg-white rounded-lg p-6 w-11/12 max-w-2xl shadow-lg';

        const title = document.createElement('h3');
        title.className = 'text-lg font-bold mb-2';
        title.innerText = `Found ${preview.duplicateCount} existing roll(s)`;
        box.appendChild(title);

        const note = document.createElement('p');
        note.className = 'text-sm text-slate-600 mb-4';
        note.innerText = 'Continuing will replace existing entries with the new data. Choose Continue to proceed or Cancel to abort.';
        box.appendChild(note);

        if (preview.duplicateRolls && preview.duplicateRolls.length) {
          const details = document.createElement('details');
          details.className = 'mb-4';
          const summary = document.createElement('summary');
          summary.className = 'text-sm text-slate-500 cursor-pointer';
          summary.innerText = 'View duplicate rolls';
          details.appendChild(summary);

          const list = document.createElement('div');
          list.className = 'text-xs text-slate-700 mt-2 whitespace-pre-wrap';
          list.innerText = preview.duplicateRolls.join(', ');
          details.appendChild(list);
          box.appendChild(details);
        }

        const actions = document.createElement('div');
        actions.className = 'flex gap-3 justify-end';

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'px-4 py-2 rounded-lg bg-slate-100 hover:bg-slate-200';
        cancelBtn.innerText = 'Cancel';
        cancelBtn.onclick = () => { document.body.removeChild(overlay); callback(false); };

        const continueBtn = document.createElement('button');
        continueBtn.className = 'px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700';
        continueBtn.innerText = 'Continue';
        continueBtn.onclick = () => { document.body.removeChild(overlay); callback(true); };

        actions.appendChild(cancelBtn);
        actions.appendChild(continueBtn);
        box.appendChild(actions);

        overlay.appendChild(box);
        document.body.appendChild(overlay);
      }

      // Clear DB handler - requires typed confirmation to avoid accidents
      if (document.getElementById('clearDbBtn')) {
        document.getElementById('clearDbBtn').addEventListener('click', async () => {
          const confirmText = prompt('Type CLEAR (uppercase) to confirm deleting ALL seats from the database');
          if (confirmText !== 'CLEAR') return;

          // disable button while running
          const btn = document.getElementById('clearDbBtn');
          btn.disabled = true;
          btn.classList.add('opacity-60');
          msg.innerHTML = '';

          try {
            const res = await fetch('/api/seats/clear', { method: 'POST' });
            const result = await res.json();
            if (!res.ok) {
              msg.innerHTML = `<p class="text-sm text-red-600">${result.message || result.error || 'Clear failed'}</p>`;
            } else {
              msg.innerHTML = `<p class="text-sm text-emerald-600">${result.message}. Deleted: <strong>${result.deleted}</strong></p>`;
            }
            // refresh status after operation
            fetchStatus();
          } catch (err) {
            console.error('Clear DB failed', err);
            msg.innerHTML = '<p class="text-sm text-red-600">Network or server error during clear</p>';
          } finally {
            btn.disabled = false;
            btn.classList.remove('opacity-60');
          }
        });
      }
    </script>
  </body>
</html>
